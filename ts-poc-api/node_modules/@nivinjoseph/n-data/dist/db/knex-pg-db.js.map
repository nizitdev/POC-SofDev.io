{"version":3,"file":"knex-pg-db.js","sourceRoot":"","sources":["../../src/db/knex-pg-db.ts"],"names":[],"mappings":"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","sourcesContent":["import { Db } from \"./db\";\nimport { given } from \"@nivinjoseph/n-defensive\";\nimport \"@nivinjoseph/n-ext\";\nimport * as Knex from \"knex\";\nimport { DbException } from \"../exceptions/db-exception\";\nimport { OperationType } from \"../exceptions/operation-type\";\nimport { DbConnectionFactory } from \"../db-connection-factory/db-connection-factory\";\nimport { TransactionProvider } from \"../unit-of-work/transaction-provider\";\nimport { inject } from \"@nivinjoseph/n-ject\";\nimport { QueryResult } from \"./query-result\";\n\n\n// public\n@inject(\"DbConnectionFactory\")\nexport class KnexPgDb implements Db\n{\n    private readonly _dbConnectionFactory: DbConnectionFactory;\n    \n    \n    public constructor(dbConnectionFactory: DbConnectionFactory)\n    {\n        given(dbConnectionFactory, \"dbConnectionFactory\").ensureHasValue();\n        \n        this._dbConnectionFactory = dbConnectionFactory;\n    }\n    \n    \n    public executeQuery<T>(sql: string, ...params: Array<any>): Promise<QueryResult<T>>\n    {\n        let promise = new Promise<QueryResult<T>>((resolve, reject) =>\n        {\n            this._dbConnectionFactory.create()\n                .then((knex: Knex) =>\n                {\n                    knex.raw(sql, params).asCallback((err, result) =>\n                    {\n                        if (err)\n                        {\n                            reject(new DbException(OperationType.query, sql, params, err));\n                        }\n                        else\n                        {\n                            resolve(new QueryResult<T>(result.rows));\n                        }\n                    });\n                })\n                .catch(err => reject(err));\n        });\n\n        return promise;\n    }\n    \n    public executeCommand(sql: string, ...params: any[]): Promise<void>\n    {\n        let promise = new Promise<void>((resolve, reject) =>\n        {\n            this._dbConnectionFactory.create()\n                .then((knex: Knex) =>\n                {\n                    knex.raw(sql, params).asCallback((err, result: any) =>\n                    {\n                        if (err)\n                        {\n                            reject(new DbException(OperationType.command, sql, params, err));\n                            return;\n                        }\n                        \n                        if (!this.validateCommandResult(result))\n                        {\n                            reject(new DbException(OperationType.command, sql, params, new Error(\"No rows were affected.\")));\n                            return;\n                        }\n                        \n                        resolve();\n                    });\n                })\n                .catch(err => reject(err));\n        });\n\n        return promise;\n    }\n    \n    public executeCommandWithinUnitOfWork(transactionProvider: TransactionProvider, sql: string, ...params: any[]): Promise<void>\n    {        \n        let promise = new Promise<void>((resolve, reject) =>\n        {\n            transactionProvider.getTransactionScope()\n                .then((trx: Knex.Transaction) =>\n                {\n                    trx.raw(sql, params).asCallback((err, result: any) =>\n                    {\n                        if (err)\n                        {\n                            reject(new DbException(OperationType.command, sql, params, err));\n                            return;\n                        }\n\n                        if (!this.validateCommandResult(result))\n                        {\n                            reject(new DbException(OperationType.command, sql, params, new Error(\"No rows were affected.\")));\n                            return;\n                        }\n\n                        resolve();\n                    });\n                })\n                .catch(err => reject(err));\n        });\n\n        return promise;\n    }\n    \n    private validateCommandResult(result: any): boolean\n    {\n        let command: string = result.command;\n        let rowCount: number = result.rowCount;\n        \n        let commands = [\"INSERT\", \"UPDATE\", \"DELETE\"];\n        if (commands.some(t => t === command))\n        {\n            if (rowCount === undefined || rowCount === null || Number.isNaN(rowCount) || rowCount <= 0)\n                return false;\n        }\n        \n        return true;\n    }\n}"]}