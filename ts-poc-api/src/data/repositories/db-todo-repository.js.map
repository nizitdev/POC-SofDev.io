{"version":3,"file":"db-todo-repository.js","sourceRoot":"","sources":["db-todo-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { TodoRepository } from \"../../domain/repositories/todo-repository\";\r\nimport { Db } from \"@nivinjoseph/n-data\";\r\nimport { given } from \"@nivinjoseph/n-defensive\";\r\nimport { inject } from \"@nivinjoseph/n-ject\";\r\nimport { Todo } from \"../../domain/aggregates/todo/todo\";\r\nimport { DomainContext } from \"@nivinjoseph/n-domain\";\r\nimport { TodoNotFoundException } from \"../../domain/exceptions/todo-not-found-exception\";\r\n\r\n\r\n@inject(\"Db\", \"DomainContext\")\r\nexport class DbTodoRepository implements TodoRepository\r\n{\r\n    private readonly _db: Db;\r\n    private readonly _domainContext: DomainContext;\r\n\r\n\r\n    public constructor(db: Db, domainContext: DomainContext)\r\n    {\r\n        given(db, \"db\").ensureHasValue().ensureIsObject();\r\n        this._db = db;\r\n        \r\n        given(domainContext, \"domainContext\").ensureHasValue().ensureIsObject();\r\n        this._domainContext = domainContext;\r\n    }\r\n\r\n\r\n    public async getAll(): Promise<ReadonlyArray<Todo>>\r\n    {\r\n        const sql = `select data from todos order by created_at;`;\r\n        const queryResult = await this._db.executeQuery<any>(sql);\r\n        return queryResult.rows.map(t => Todo.deserialize(this._domainContext, t.data));\r\n    }\r\n    \r\n    public async get(id: string): Promise<Todo>\r\n    {\r\n        given(id, \"id\").ensureHasValue().ensureIsString();\r\n\r\n        id = id.trim();\r\n        const sql = `select data from todos where id = ?;`;\r\n        const result = await this._db.executeQuery<any>(sql, id);\r\n        if (result.rows.length === 0)\r\n            throw new TodoNotFoundException(id);\r\n        \r\n        return Todo.deserialize(this._domainContext, result.rows[0].data);\r\n    }\r\n\r\n    public async save(todo: Todo): Promise<void>\r\n    {\r\n        given(todo, \"todo\").ensureHasValue().ensureIsType(Todo);\r\n\r\n        const exists = await this.checkIfTodoExists(todo.id);\r\n        if (exists && todo.hasChanges)\r\n        {\r\n            const sql = `update todos \r\n                            set version = ?, updated_at = ?, data = ? \r\n                            where id = ? and version = ?;`;\r\n\r\n            const params = [todo.currentVersion, todo.updatedAt, todo.serialize(), todo.id, todo.retroVersion];\r\n\r\n            await this._db.executeCommand(sql, ...params);\r\n        }\r\n        else\r\n        {\r\n            const sql = `insert into todos \r\n                            (id, version, created_at, updated_at, data) \r\n                            values(?, ?, ?, ?, ?);`;\r\n\r\n            const params = [todo.id, todo.version, todo.createdAt, todo.updatedAt, todo.serialize()];\r\n\r\n            await this._db.executeCommand(sql, ...params);\r\n        }\r\n    }\r\n\r\n    public async delete(id: string): Promise<void>\r\n    {\r\n        given(id, \"id\").ensureHasValue().ensureIsString();\r\n\r\n        id = id.trim();\r\n        const exists = await this.checkIfTodoExists(id);\r\n        if (!exists)\r\n            return;\r\n        \r\n        const sql = `delete from todos where id = ?;`;\r\n\r\n        await this._db.executeCommand(sql, id);\r\n    }\r\n\r\n\r\n    private async checkIfTodoExists(id: string): Promise<boolean>\r\n    {\r\n        const sql = `select exists (select 1 from todos where id = ?);`;\r\n\r\n        const result = await this._db.executeQuery<any>(sql, id);\r\n        return result.rows[0].exists;\r\n    }\r\n}"]}